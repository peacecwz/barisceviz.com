<!DOCTYPE html><html lang="en"><head><meta name="description" content="Baris Ceviz Software Engineer @Trendyol, Microsoft Student Partner"/><meta name="author" content="Baris Ceviz"/><link href="https://fonts.googleapis.com/css?family=Inter:400,600,700&amp;display=swap" rel="stylesheet"/><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><meta name="description" content="Jedi Software Engineer"/><meta name="twitter:card" content="summary_large_image"/><meta name="twitter:site" content="@PeaceCwz"/><meta name="twitter:creator" content="@PeaceCwz"/><meta property="og:url" content="https://barisceviz.com"/><meta property="og:type" content="website"/><meta property="og:description" content="Jedi Software Engineer"/><meta property="og:locale" content="tr_TR"/><meta property="og:site_name" content="Baris Ceviz"/><title>Installing MicroPython on the ESP32 (macOS) | Baris Ceviz</title><meta name="robots" content="index,follow"/><meta name="googlebot" content="index,follow"/><meta name="next-head-count" content="14"/><noscript data-n-css="true"></noscript><link rel="preload" href="/_next/static/chunks/main-13a97229ba9cfc2a8ca6.js" as="script"/><link rel="preload" href="/_next/static/chunks/webpack-22eaaa575d3c455933b4.js" as="script"/><link rel="preload" href="/_next/static/chunks/framework.1cde045124b4a7914091.js" as="script"/><link rel="preload" href="/_next/static/chunks/commons.5fafacf9ea4b892375d0.js" as="script"/><link rel="preload" href="/_next/static/chunks/266fce294f4d04e0decbbbd461ff4d16b8e17596.cb6044a5807bfb810729.js" as="script"/><link rel="preload" href="/_next/static/chunks/pages/_app-6a99d2d21d3a14a7bdb2.js" as="script"/><link rel="preload" href="/_next/static/chunks/78e521c3.7418446e8c21049a3cf3.js" as="script"/><link rel="preload" href="/_next/static/chunks/9469946b6dc0e9dd78922b308584ec0e18d81f50.2be113f6772e8c122bb8.js" as="script"/><link rel="preload" href="/_next/static/chunks/pages/posts/dotnet-core-hosted-service-ile-azure-service-bus-kullanimi-7928d271e24dff7743d1.js" as="script"/></head><body><div id="__next"><style data-emotion-css="1eeqi1r">html{line-height:1.15;-webkit-text-size-adjust:100%;}body{margin:0;}main{display:block;}h1{font-size:2em;margin:0.67em 0;}hr{box-sizing:content-box;height:0;overflow:visible;}pre{font-family:monospace,monospace;font-size:1em;}a{background-color:transparent;}abbr[title]{border-bottom:none;-webkit-text-decoration:underline;text-decoration:underline;-webkit-text-decoration:underline dotted;-webkit-text-decoration:underline dotted;text-decoration:underline dotted;}b,strong{font-weight:bolder;}code,kbd,samp{font-family:monospace,monospace;font-size:1em;}small{font-size:80%;}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline;}sub{bottom:-0.25em;}sup{top:-0.5em;}img{border-style:none;}button,input,optgroup,select,textarea{font-family:inherit;font-size:100%;line-height:1.15;margin:0;}button,input{overflow:visible;}button,select{text-transform:none;}button::-moz-focus-inner,[type="button"]::-moz-focus-inner,[type="reset"]::-moz-focus-inner,[type="submit"]::-moz-focus-inner{border-style:none;padding:0;}fieldset{padding:0.35em 0.75em 0.625em;}legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal;}progress{vertical-align:baseline;}textarea{overflow:auto;}[type="checkbox"],[type="radio"]{box-sizing:border-box;padding:0;}[type="number"]::-webkit-inner-spin-button,[type="number"]::-webkit-outer-spin-button{-webkit-appearance:none !important;}input[type="number"]{-moz-appearance:textfield;}[type="search"]{-webkit-appearance:textfield;outline-offset:-2px;}[type="search"]::-webkit-search-decoration{-webkit-appearance:none !important;}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit;}details{display:block;}summary{display:list-item;}template{display:none;}[hidden]{display:none !important;}html{box-sizing:border-box;font-family:sans-serif;}*,*::before,*::after{box-sizing:border-box;}blockquote,dl,dd,h1,h2,h3,h4,h5,h6,hr,figure,p,pre{margin:0;}button{background:transparent;padding:0;}fieldset{margin:0;padding:0;}ol,ul{margin:0;padding:0;}html{font-family:"Inter",system-ui,sans-serif;line-height:1.5;-webkit-font-smoothing:antialiased;-webkit-text-size-adjust:100%;text-rendering:optimizelegibility;}hr{border-top-width:1px;}img{border-style:solid;}textarea{resize:vertical;}button,[role="button"]{cursor:pointer;}button::-moz-focus-inner{border:0 !important;}table{border-collapse:collapse;}h1,h2,h3,h4,h5,h6{font-size:inherit;font-weight:inherit;}a{color:inherit;-webkit-text-decoration:inherit;text-decoration:inherit;}button,input,optgroup,select,textarea{padding:0;line-height:inherit;color:inherit;}pre,code,kbd,samp{font-family:SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;}img,svg,video,canvas,audio,iframe,embed,object{display:block;vertical-align:middle;}img,video{max-width:100%;height:auto;}html{line-height:1.5;color:#1A202C;}*,*::before,*::after{border-width:0;border-style:solid;border-color:#E2E8F0;}input:-ms-input-placeholder,textarea:-ms-input-placeholder{color:#A0AEC0;}input::-ms-input-placeholder,textarea::-ms-input-placeholder{color:#A0AEC0;}input::-webkit-input-placeholder,textarea::-webkit-input-placeholder{color:#A0AEC0;}input::-moz-placeholder,textarea::-moz-placeholder{color:#A0AEC0;}input:-ms-input-placeholder,textarea:-ms-input-placeholder{color:#A0AEC0;}input::placeholder,textarea::placeholder{color:#A0AEC0;}</style><div class="css-0"><div><style data-emotion-css="1la5rf0">.css-1la5rf0{background-color:rgba(255,255,255,.9);}</style><div class="style__FrostedContainer-sc-1bwvafx-0 hyTEfc css-1la5rf0"><div class="Container__OffsetContainer-tyetr5-0 fEMxwn css-0"><style data-emotion-css="rhe48">.css-rhe48{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:justify;-webkit-justify-content:space-between;-ms-flex-pack:justify;justify-content:space-between;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;padding-top:0.5rem;padding-bottom:0.5rem;}</style><nav class="css-rhe48"><style data-emotion-css="15kq0nh">.css-15kq0nh{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;margin-right:1.25rem;}</style><div class="css-15kq0nh"><style data-emotion-css="ng0vnu">.css-ng0vnu{border-radius:0.25rem;font-weight:600;display:-webkit-inline-box;display:-webkit-inline-flex;display:-ms-inline-flexbox;display:inline-flex;-webkit-appearance:none;-moz-appearance:none;appearance:none;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;-webkit-transition:all 250ms;transition:all 250ms;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;position:relative;white-space:nowrap;vertical-align:middle;line-height:1.2;outline:none;height:2.5rem;min-width:2.5rem;font-size:1rem;padding-left:1rem;padding-right:1rem;color:inherit;margin-left:0.5rem;margin-right:0.5rem;}.css-ng0vnu:hover{background-color:rgba(85,51,255,.35);}.css-ng0vnu:focus{box-shadow:0 0 0 3px rgba(66,153,225,0.6);}.css-ng0vnu:active,.css-ng0vnu[data-active=true]{background-color:#E2E8F0;}.css-ng0vnu:disabled,.css-ng0vnu:disabled:focus,.css-ng0vnu:disabled:hover,.css-ng0vnu[aria-disabled=true],.css-ng0vnu[aria-disabled=true]:focus,.css-ng0vnu[aria-disabled=true]:hover{opacity:0.4;cursor:not-allowed;box-shadow:none;}</style><button type="button" class="css-ng0vnu">Baris Ceviz</button></div><style data-emotion-css="zv2ir3">.css-zv2ir3{display:block;margin-left:1rem;margin-right:1rem;}@media screen and (min-width:48em){.css-zv2ir3{display:none;}}</style><div class="css-zv2ir3"><svg stroke="currentColor" fill="none" stroke-width="2" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" color="black" style="color:black" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg></div><style data-emotion-css="6huw4y">.css-6huw4y{-webkit-align-items:start;-webkit-box-align:start;-ms-flex-align:start;align-items:start;display:none;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;width:100%;}@media screen and (min-width:48em){.css-6huw4y{display:block;width:auto;}}</style><div class="css-6huw4y"><button type="button" class="css-ng0vnu">About</button><button type="button" class="css-ng0vnu">Blog</button><button type="button" class="css-ng0vnu">Events</button></div></nav></div></div><style data-emotion-css="q0tk53">.css-q0tk53{height:56px;}</style><div class="css-q0tk53"></div></div><div class="Container__OffsetContainer-tyetr5-0 fEMxwn css-0"><style data-emotion-css="7i1vm3">.css-7i1vm3{font-size:1.875rem;line-height:1.25;font-weight:700;font-family:"Inter",system-ui,sans-serif;margin-top:1.5rem;margin-bottom:0.5rem;}@media screen and (min-width:48em){.css-7i1vm3{font-size:2.25rem;}}</style><h1 class="css-7i1vm3">.NET Core Hosted Service ile Azure Service Bus Kullanımı</h1><style data-emotion-css="10x5xli">.css-10x5xli{font-family:"Inter",system-ui,sans-serif;margin-top:1rem;line-height:1.625;}</style><p class="css-10x5xli"><style data-emotion-css="etaq6l">.css-etaq6l{max-width:36rem;width:100%;margin-top:0.5rem;margin-bottom:0.5rem;}</style><img alt="alt text" class="css-etaq6l"/></p><p class="css-10x5xli">Bu yazımızda .NET Core içerisinde gelen HostedServices ile Azure Service Bus ürünü nasıl konuşur ve Producer &amp; Consumer konularını konuşacağız.</p><style data-emotion-css="nvmesu">.css-nvmesu{font-size:1.25rem;line-height:1.25;font-weight:700;font-family:"Inter",system-ui,sans-serif;margin-top:1.5rem;margin-bottom:0.5rem;}@media screen and (min-width:48em){.css-nvmesu{font-size:1.5rem;}}</style><h2 class="css-nvmesu">Azure Service Bus</h2><p class="css-10x5xli">Microsoft Azure üzerinde PaaS olarak sunulan scalable bir messaging ürünüdür. Event Driven Architecture gibi konularda sık tercih edilen bu messaging ürünlerinden Cloud Vendor üzerinde sunulan bir servistir. Azure üzerinde RabbitMQ ve Apache Kafka da sunulmaktadır fakat bu diğer iki ürün arasındaki en büyük fark, infrastructure maliyetleri, maintenance gibi operasyonel süreçlerden kurtulup sadece scale ettiğiniz ve infrastructure ı düşünmeden çalışabilmenizi sağlamaktadır.</p><p class="css-10x5xli"><img alt="alt text" class="css-etaq6l"/></p><p class="css-10x5xli">En temel fiyatlandırma yukarıdaki gördüğünüz tablo ile açıklanabilir. Bu fiyatlar West Europe fiyatlarıdır. Bu fiyatlandırmaları daha detaylandırmak ve incelemk isterseniz Azure Calculator üzerinden fiyatlandırmalarınızı hesaplayabilirsiniz</p><style data-emotion-css="q6v3zd">.css-q6v3zd{font-size:1.25rem;line-height:1.25;font-weight:700;font-family:"Inter",system-ui,sans-serif;margin-top:1.5rem;margin-bottom:0.5rem;}</style><h3 class="css-q6v3zd">Azure Service Bus Oluşturma</h3><p class="css-10x5xli">Azure Service Bus oluşturmanız için en temel ihtiyaçlardan bir tanesi Azure üzerinde geçerli bir aboneliğinizin olması gerekmektedir.</p><p class="css-10x5xli">Azure Portal üzerinden Create a Resource &gt; Integration &gt; Service Bus seçerek oluşturma ekranına girelim.</p><p class="css-10x5xli">Buradaki en çok dikkat etmemiz gereken nokta Pricing tarafıdır. Azure, öneri olarak Premium sunmaktadır fakat buradaki ihtiyacınızı belirleyerek ilgili tier ı seçmeniz daha doğru olacaktır.</p><p class="css-10x5xli"><img alt="alt text" class="css-etaq6l"/></p><p class="css-10x5xli">Buradaki Standard ve Premium tier ları arasında en önemli farklardan birisi resource un dedicated veya shared ortamlarda sunulmasıdır. Dedicated ortam daha performanslı ama maliyeti yüksek olacaktır. Yüksek seviyede yük sahibi iseniz Premium mantıklıdır. Standard ile Basic arasında ise en büyük farklılıklardan birisi topic kavramı Standard ve sonraki tierlar üzerinde gelmektedir. Bu yüzden orta ölçekli uygulamalar için Standard paketini seçmekteyim.</p><p class="css-10x5xli">Standard to Premium migration için safe bir geçiş sağlamaktadır. Post-Migration ile tüm trafiğinizi Premium Service Bus üzerine aldığınızda artık Standard paketi kullanmadan devam edebilirsiniz. Aslında migration sürecinde iki farklı resource oluşturup aralarında post-migration sağlamaktadır.</p><p class="css-10x5xli"><img alt="alt text" class="css-etaq6l"/></p><p class="css-10x5xli">Yukarıdaki ekran görüntüsündeki gibi resource ve location seçimlerimi yapıyorum ve oluşturuyorum.</p><p class="css-10x5xli"><img alt="alt text" class="css-etaq6l"/></p><p class="css-10x5xli">Service Bus resource unu oluşturduğumuza göre artık Queue ve Topics arasındaki farkı konuşabiliriz. Bu yazımda çok darlamak istemiyorum fakat en temel farkını çok basitçe ve örnekle aktaracağım</p><p class="css-10x5xli">Queue üzerinde bir mesajı bir consumer (tüketen) kullanabilirken, topics üzerinden geçen bir mesajı birden fazla consumer kullanabilmektedir.</p><p class="css-10x5xli">Örneğin; ürün oluşturduğuna dair bir mesaj gönderiyorsunuz ve bu mesaj atıldıktan sonra SMS, Email, Teslimat paketi oluşturma işlemlerini yapıyorsunuz ve bunu paralel olarak yapmak istiyorsunuz diyelim. Bu noktada Topics kullanmanız gerekmektedir. Siz mesajı verdiğiniz zaman bu mesaj, SMS için ayrı, Email için ayrı ve Teslimat paketi için ayrı kullanılacak ve paralel olarak çalışabilecektir.</p><h2 class="css-nvmesu">.NET Core &amp; ServiceBus ile Consumer Projesi oluşturma</h2><p class="css-10x5xli">Boş console application oluşturalım ve içerisine birkaç package kurarak hazırlayalım.</p><pre><style data-emotion-css="homfir">.css-homfir{display:inline-block;font-family:SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:0.875rem;padding-left:0.2em;padding-right:0.2em;border-radius:0.25rem;background-color:#EDF2F7;color:#1A202C;padding:0.5rem;margin-top:0.5rem;max-width:100%;overflow:scroll;}</style><code class="language-csharp css-homfir">    dotnet new console -n ServiceBusExample
</code></pre><p class="css-10x5xli">Ardından proje içerisine girelim ve aşağıdaki iki önemli paketi kuralım</p><pre><code class="language-csharp css-homfir">    dotnet add package Microsoft.Extensions.Hosting
</code></pre><p class="css-10x5xli">Bu paket HostedServices ve Dependency Injection’ı configure edebilmenizi sağlaması açısından hazırlanmış bir pakettir.</p><pre><code class="language-csharp css-homfir">    dotnet add package Microsoft.Azure.ServiceBus
</code></pre><p class="css-10x5xli">Bu paket ise Azure ServiceBus integration sağlamanız için gereken Client library package ıdır.</p><p class="css-10x5xli">Geliştireceğimiz Consumer projesinde configuration larımızı CommandLine Arguments veya Environment Variables olarak alacağım. İsterseniz JsonFileConfiguration ekleyebilirsiniz. Configuration için Program.cs içerisinde basit bir configure method u yazalım</p><pre><code class="language-cs css-homfir">    private static void ConfigureHostConfiguration(IConfigurationBuilder builder)
    {
        builder
            .AddEnvironmentVariables()
            .AddCommandLine(Arguments);
    }
</code></pre><p class="css-10x5xli">Burada Arguments olarak belirttiğimiz aslında Main methodunda gelen args parametresidir. Bu parametreyi class içerisine taşıyalım</p><pre><code class="language-cs css-homfir">    private static string[] Arguments { get; set; }

    static void Main (string[] args) {
        Arguments = args;

        Console.WriteLine (&quot;Hello World!&quot;);
    }
</code></pre><p class="css-10x5xli">Böylelikle Configuration methodu artık Arguments a erişebilir. Host umuzu basitçe ayağa kaldıralmanın vakti geldi. DefaultHostBuilder ile basit bir host build edeceğiz ve onu çalıştıracağız. Host kapanana kadar uygulamamız çalışacaktır. Böylelikle Kubernetes üzerinde rahatlıkla çalıştırabilir ve consumer projelerinizi ayaklandırabilirsiniz.</p><pre><code class="language-cs css-homfir">    static async Task Main(string[] args)
    {
        Arguments = args;

        var host = Host.CreateDefaultBuilder(args)
        .ConfigureHostConfiguration(ConfigureHostConfiguration)
        .Build();

        await host.RunAsync();
    }
</code></pre><p class="css-10x5xli">Host async olarak run edilebilidiği için burada Main methodumuzu async olarak çalıştırmaya başladık. Yazdığımzı Configure methodunu Host Configuration ı olarak verdik ve artık Command-line ve Environment Variables olarak configleri alabiliriz.</p><p class="css-10x5xli">Artık HostedService oluşturmamızın vakti geldi 🎉🎉 Bir host içerisine birden fazla HostedService yerleştirebilirsiniz ve bu HostedServices lar üzerinde Dependency Injection uygulayabilirsiniz. ConsumerHostedService adında bir class oluşturalım ve bunu HostedService olarak initialize etmeye başlayalım.</p><pre><code class="language-cs css-homfir">    public class ConsumerhostedService : IHostedService, IDisposable
    {
        public Task StartAsync(CancellationToken cancellationToken)
        {
            Console.WriteLine(&quot;Started Hosted Service&quot;);

            return Task.CompletedTask;
        }

        public Task StopAsync(CancellationToken cancellationToken)
        {
            Console.WriteLine(&quot;Stopping Hosted Service&quot;);

            return Task.CompletedTask;
        }

        public void Dispose()
        {
            Console.WriteLine(&quot;Dispossing...&quot;);
        }
    }
</code></pre><p class="css-10x5xli">Disposable bir hosted service yarattığımız zaman en temelde implement etmemiz gereken methodlar bu şekildedir. Start ve Stop bölümünde connection kurduğumuz external service leri open ve close edebiliriz. Dispose methodunda ise artık bu objeleri GC’ye teslim edebiliriz.</p><p class="css-10x5xli">StartAsync ve StopAsync ile gelen CancellationToken lar önemlidir. Buradaki cancellationToken ları açacağınız connection veya thread lere vermenizi tavsiye ederim. HostedService durdurulduğunda böylelikle o anda gerçekleşen process i de CancellationToken sayesinde durdurabilirsiniz. Böylelikle uygulamanızı sağlıklı bir şekilde devam ettirmiş olur veya HostedService kapatıldığını anladığınzıda yapmanız gereken son işlemleri gerçekleştirip, uygulamanızın kapanmasını sağlayabilirsiniz.</p><pre><code class="language-cs css-homfir">
    private static void ConfigureServices(HostBuilderContext hostBuilderContext,
        IServiceCollection serviceCollection)
    {
        serviceCollection.AddHostedService&lt;ConsumerhostedService&gt;();
    }
</code></pre><p class="css-10x5xli">Oluşturduğumuz HostedService i Program.cs içerisinde ConfigureService methodu oluşturarak Dependency Injection a eklemek adına hazırlayalım. Ardından bu methodumuzu HostBuilder içerisine verelim ve Host’u bu service ler ile birlikte oluşturmaya başlasın.</p><pre><code class="language-cs css-homfir">    static async Task Main(string[] args)
    {
        Arguments = args;

        var host = Host.CreateDefaultBuilder(args)
        .ConfigureHostConfiguration(ConfigureHostConfiguration)
        .ConfigureServices(ConfigureServices) // Add ConfigureServices method to Host
        .Build();

        await host.RunAsync();
    }
</code></pre><p class="css-10x5xli">Uygulamamızı çalıştırdığımızda gördüğümüz gibi HostedService imiz çalışmaktadır.</p><p class="css-10x5xli"><img alt="alt text" class="css-etaq6l"/></p><p class="css-10x5xli">Durdurmak istediğimizde ise gördüğünüz gibi kill etme süreci de bu şekilde işlemektedir.</p><p class="css-10x5xli"><img alt="alt text" class="css-etaq6l"/></p><p class="css-10x5xli">Bunları tamamladığımıza göre artık ServiceBus Integration işlemlerimize geçebiliriz. Bu aşamalarda ServiceBus üzerinde Queue oluşturduğumuzu varsayarak geliştireceğiz. Son aşamada ServiceBus üzerinde Queue oluşturup aldığımız ConnectionString i uygulamamıza verip çalıştığını göreceğiz</p><h3 class="css-q6v3zd">Service Bus Integration</h3><p class="css-10x5xli">ConfigureServices methodumuzda ServiceBus için QueueClient initialize edelim ve IoC içerisine register edelim. Ardından da HostedService içerisine inject ederek consumer ımızın son aşamasını hazırlayalım.</p><p class="css-10x5xli">Bu method içerisinde configuration üzerinden gelen ServiceBusConnectionString ve ServiceBusQueueName adında iki tane config alacağız ve bunlarla QueueClient ı initialize edeceğiz</p><pre><code class="language-cs css-homfir">    private static void ConfigureServices(HostBuilderContext hostBuilderContext,
        IServiceCollection serviceCollection)
    {
        var configuration = hostBuilderContext.Configuration;

        string connectionString = configuration.GetValue&lt;string&gt;(&quot;ServiceBusConnectionString&quot;);
        string queueName = configuration.GetValue&lt;string&gt;(&quot;ServiceBusQueueName&quot;);

        if (string.IsNullOrEmpty(connectionString))
        {
            throw new ArgumentException(&quot;Service Bus Connection String cannot be null.&quot;);
        }

        if (string.IsNullOrEmpty(queueName))
        {
            throw new ArgumentException(&quot;Service Bus Queue Name cannot be null.&quot;);
        }

        var queueClient = new QueueClient(connectionString, queueName);

        serviceCollection.AddLogging();

        serviceCollection.AddSingleton&lt;IQueueClient&gt;(queueClient);
        serviceCollection.AddHostedService&lt;ConsumerhostedService&gt;();
    }
</code></pre><p class="css-10x5xli">Burada configler boş gelirse uygulamamızı direkt patlatıyoruz ve devam etmesini engelliyoruz. Bu configler bizim için required seviyesindedir. Configler düzgün geldiğinde artık QueueClient ı initialize edip, IQueueClient ile IoC mize register edebiliriz. Aynı zamanda Logging içinde AddLogging diyerek IoC içerisine register edelim. Console içerisine loglama yapabilmemiz için ihtiyacımız olacaktır.</p><pre><code class="language-cs css-homfir">    private readonly IQueueClient _queueClient;
    private readonly ILogger&lt;ConsumerhostedService&gt; _logger;

    public ConsumerhostedService(IQueueClient queueClient,
        ILogger&lt;ConsumerhostedService&gt; logger)
    {
            _queueClient = queueClient;
            _logger = logger;
    }
</code></pre><p class="css-10x5xli">ConsumerHostedService içerisinde QueueClient ve Logger ı inject edelim. Ardından Queue binding operasyonlarımızı yapalım</p><pre><code class="language-cs css-homfir">        public Task StartAsync(CancellationToken cancellationToken)
        {
            var messageHandlerOptions = new MessageHandlerOptions(e =&gt;
            {
                OnError(e.Exception);
                return Task.CompletedTask;
            })
            {
                MaxConcurrentCalls = 3,
                AutoComplete = false
            };

            _queueClient.RegisterMessageHandler(OnProcess, messageHandlerOptions);
            _logger.LogInformation(&quot;Registered to ServiceBus&quot;);

            return Task.CompletedTask;
        }

        private Task OnProcess(Message message, CancellationToken cancellationToken)
        {
            return Task.CompletedTask;
        }

        private void OnError(Exception exception)
        {
            _logger.LogError($&quot;Get exception on processing queue {exception.Message}&quot;, exception);
        }
</code></pre><p class="css-10x5xli">StartAsync içerisinde Queue üzerinde gelecek Message ları handle edebilmemiz için OnProcess adında bir methodumuzu register ediyoruz. Queue içerisine eklenen her mesajda OnProcess methodu tetiklenecektir. MessageHnadlerOptions üzerinde Concurrent işlenebilecek mesaj sayısını, işlenen mesajların otomatik silinmesi gibi ayarları yapabiliyorsunuz. Ben AutoComplete özelliğini kapatıyorum. Bunun sebebi, olası aldığım hatalarda tekrarlayabilmek adınadır. Eğer böyle bir ihtiyacınız yok ise AutoComplete i true olarak ayarlayabilir ve mesajlarınız exception almadığı sürece Queue üzerinden düşmeyecektir.</p><p class="css-10x5xli">Hata alma durumunda aldığı exception ı OnError adında bir method a gönderelim. Ardından bu method basit bir loglama işlemi gerçekleştirsin. Burada custom logicler yazabilirsiniz. Örneğin bir mesajı 3 kez işlemeyi denesin, eğer 3 den fazla hata alırsa bu mesajı queue dan silsin gibi retry mekanizmaları yaratabilirsiniz</p><pre><code class="language-cs css-homfir">        public async Task StopAsync(CancellationToken cancellationToken)
        {
            await _queueClient.CloseAsync();
        }
</code></pre><p class="css-10x5xli">StopAsync içerisinde QueueClient ı stop ederek artık consume etmesini kapatabiliriz.</p><pre><code class="language-cs css-homfir">        private Task OnProcess(Message message, CancellationToken cancellationToken)
        {
            var json = Encoding.UTF8.GetString(message.Body);
            _logger.LogInformation($&quot;Queue Message: {json}&quot;);

            var data = JsonSerializer.Deserialize&lt;object&gt;(json);

            // Your custom logics here ...

            return Task.CompletedTask;
        }
</code></pre><p class="css-10x5xli">OnProcess içerisinde gelen message byte array olarak gelmektedir. Bu gelen byte array i JSON string e çevirip ardından Deserialize edebilirsiniz. Buradaki kritik nokta ise eğer yüksek boyutlarda mesajlar geliyorsa OutOfMemory yaşamamak için MemoryStream ile Stream Deserializer yapabilirsiniz. Böylelikle büyük JSON verilerini OutOfMemory hatası almadan deserialize edebilirsiniz. Async bir method çağırdığınız takdirde retun Task.CompletedTask dönmenize de gerek kalmayacaktır.</p><h3 class="css-q6v3zd">Service Bus Queue Oluşturma</h3><p class="css-10x5xli">Azure Portal üzerinden Queue oluşturalım ve ConnectionString alalım. Böylelikle uygulamamızı çalışması için gereken son aşamayı tamamlamış olacağız.</p><p class="css-10x5xli"><img alt="alt text" class="css-etaq6l"/></p><p class="css-10x5xli">Burada ServiceBus üzerinde built-in gelen birtakım özellikler bulunmaktadır. Benim sevdiğim en güzel özelliklerden birisi duplication detection özelliğidir. Bu özelliği enable ettiğinizde belirli bir aralıktaki tekrarlanan mesajları engelleyebilirsiniz. Böylelikle sisteminizin daha stabil olmasını sağlarsınız. Bir diğer özelliği ise session özelliğidir. Burada ise queue içerisindeki mesajların atıldığı sırada consume edilmesinin garantisini vermektedir. First In First Out (FIFO) olarak çalışan ve sizin attığınız sırada çalışmasını garanti etmektedir. Böylelikle session oluşturarak farklı bir transactional yapı kullanabilirsiniz. Bu özellik distributed sistemler için tehlikelidir. Bu yüzden mimarinizi bunun üzerine kurmamanızı tavsiye edebilirim. Expire olan message ları otomatik olarak dead letter a atabilir ve message kaybetmenizi minimum a düşürebilirsiniz. Buradaki dikkat edebileceğiniz bir diğer özellik ise Lock Duration olacaktır. Ack göndermediğiniz mesajlar için belirlediğiniz bir lock time yaratıyor ve bu süre içerisinde başka consumer bu mesajı consume edemiyor. Bu süreyi aştığında ve Ack almadıysa başka consumerlar tarafından consume edilebilmektedir.</p><p class="css-10x5xli"><img alt="alt text" class="css-etaq6l"/></p><p class="css-10x5xli">Oluşturduğumuz Queue üzerinden Shared access policies bölümünden Policy yaratalım. Burada oluşturacağımız Policy, tam olarak ne yapacağını belirtmekteyiz. Consumer için Listen Policy, Producer için ise Send Policy tanımlayarak iki farklı ConnectionString yaratabilir, böylelikle Security açısından ortamlarınızın güvenliğini sağlayabilirsiniz. Bu örneğimizde hem Consumer hem de producer olarak yapacağımız için Manage i tercih ediyoruz.</p><p class="css-10x5xli"><img alt="alt text" class="css-etaq6l"/></p><p class="css-10x5xli">ConnectionString içerisindeki EntityPath i silebilirsiniz. Uygulamamız içerisinde zaten QueueName olarak vereceğimiz için ConnectionString e eklememize gerek yok.</p><h3 class="css-q6v3zd">Consumer Uygulamasını Test Edelim</h3><p class="css-10x5xli">Gerekli olan tüm aşamaları tamamladığımıza göre artık çalıştırabiliriz. Uygulamamıza Environment Variable ya da Command-line üzerinden ConnectionString ve QueueName i iletebiliriz. Ben Command-line üzerinden tercih edeceğim</p><pre><code class="language-cs css-homfir">    dotnet run /&quot;ServiceBusConnectionString={ServiceBusConnectionString}&quot; /&quot;ServiceBusQueueName={ServiceBusQueueName}&quot;
</code></pre><p class="css-10x5xli">Yukarıdaki komut içerisinde {ServiceBusConnectionString} ve {ServiceBusQueueName} kendi oluşturduğunuz ConnectionString ve QueueName ile değiştiriniz.</p><p class="css-10x5xli"><img alt="alt text" class="css-etaq6l"/></p><p class="css-10x5xli">Ardından test için Azure Portal üzerinden oluşturduğunuz Queue içerisinde Service Bus Explorer ile mesaj gönderebilirsiniz.</p><p class="css-10x5xli"><img alt="alt text" class="css-etaq6l"/></p><p class="css-10x5xli">Gördüğünüz gibi gönderdiğimiz message uygulamamıza iletildi ve log olarak yazdı. Consumer bölümümüz başarılı bir şekilde çalıştı.</p><h2 class="css-nvmesu">Producer Uygulaması Geliştirme</h2><p class="css-10x5xli">Consumer ile Producer arasındaki en büyük farklardan birisi, RegisterMessageHandler ı çağırmanıza gerek yoktur. Yapmanız gereken IQueueClient ı mesajı göndermek istediğiniz class içerisine inject ettikten sonra aşağıdaki gibi örnek bir kod çalıştırmanız yeterli olacaktır. Örnek olarak consume ettiğim mesajı tekrar aynı queue ya bırakalım.</p><pre><code class="language-cs css-homfir">        private async Task OnProcess(Message message, CancellationToken cancellationToken)
        {
            var json = Encoding.UTF8.GetString(message.Body);
            _logger.LogInformation($&quot;Queue Message: {json}&quot;);

            var data = JsonSerializer.Deserialize&lt;object&gt;(json);

            if (data != null)
            {
                var producerData = new
                {
                    message = &quot;Hello Service Bus from Producer&quot;
                };

                string producerJson = JsonSerializer.Serialize(producerData);

                await _queueClient.SendAsync(new Message(Encoding.UTF8.GetBytes(producerJson)));
            }
        }
</code></pre><p class="css-10x5xli">Gelen mesaj boş değilse producerData adında bir obje oluşturuluyor ve bu JSON string olarak serialize ediliyor ve ardından byte array e çevirilerek Message class ına verilerek gönderiliyor. Bu message class ı içerisinde custom properties ler de gönderebilirsiniz. Örneğin kaç kez retry ettiği, veya birtakım metadata lar olabilir (CorrelationId, Sender Agent Name vs.) SendAsync ile birden fazla mesajı aynı zamanda da gönderebilirsiniz. List olarak da kabul etmektedir. Burada da OutOfMemory yaşamamak adına Serialize işlemini de Stream olarak uygulayabilirsiniz</p><h2 class="css-nvmesu">Sonlandıralım</h2><p class="css-10x5xli">Bu yazımızda temel olarak Azure Service Bus kullanımını ve bunu .NET Core uygulamalarında en ideal yöntem olan HostedService ile nasıl Consumer veya Producer olarak sağladığımızı, Dependency Injection uygulayarak temiz bir yapıda kurduk. Unit Test yazacağınız ve QueueClient ı kolayca Mocklayabileceksiniz. Böylelikle 3rd party integration larınızı da kolayca Mock layarak business logic testlerinizi yazabilirsiniz.</p><p class="css-10x5xli">Twitter ve Github üzerinden takip etmeyi unutmuyoruzdur umarım 😇😇😇</p><p class="css-10x5xli">Artık Youtube üzerinden de yayında olacağım. Kanalıma abone olmanızı ve bildirimleri açarak en güncel teknolojileri nasıl uyguladığımı takip edebilirsiniz 🙏🙏🙏</p><p class="css-10x5xli">İyi okumalar :) 🎉🤞🏻</p></div><style data-emotion-css="12ctc1m">.css-12ctc1m{border-top-width:1px;margin-top:2rem;}</style><div class="css-12ctc1m"><div class="Container__OffsetContainer-tyetr5-0 fEMxwn css-0"><style data-emotion-css="70qvj9">.css-70qvj9{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;}</style><div class="css-70qvj9"><style data-emotion-css="zrhkc7">.css-zrhkc7{display:none;-webkit-box-flex:1;-webkit-flex-grow:1;-ms-flex-positive:1;flex-grow:1;}@media screen and (min-width:48em){.css-zrhkc7{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;}}</style><div class="css-zrhkc7"><style data-emotion-css="1481rn8">.css-1481rn8{font-family:"Inter",system-ui,sans-serif;}</style><p class="css-1481rn8">Browse source code on<style data-emotion-css="yfj6sl">.css-yfj6sl{-webkit-transition:all 0.15s ease-out;transition:all 0.15s ease-out;cursor:pointer;-webkit-text-decoration:none;text-decoration:none;outline:none;color:#3182ce;}.css-yfj6sl:hover{-webkit-text-decoration:underline;text-decoration:underline;}.css-yfj6sl:focus{box-shadow:0 0 0 3px rgba(66,153,225,0.6);}.css-yfj6sl:disabled,.css-yfj6sl:disabled:focus,.css-yfj6sl:disabled:hover,.css-yfj6sl[aria-disabled=true],.css-yfj6sl[aria-disabled=true]:focus,.css-yfj6sl[aria-disabled=true]:hover{opacity:0.4;cursor:not-allowed;-webkit-text-decoration:none;text-decoration:none;}</style><a href="https://github.com/peacecwz/barisceviz.com" class="css-yfj6sl"> GitHub</a></p></div><style data-emotion-css="d6ypfp">.css-d6ypfp{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;font-size:2.5em;color:#000;margin-top:1.5rem;margin-bottom:1.5rem;}</style><div class="css-d6ypfp"><style data-emotion-css="uhmbuq">.css-uhmbuq{-webkit-transition:all .15s ease-in-out;transition:all .15s ease-in-out;margin-right:0.5rem;}.css-uhmbuq:hover{-webkit-transform:scale(1.05);-ms-transform:scale(1.05);transform:scale(1.05);}</style><div class="css-uhmbuq"><style data-emotion-css="u5zpo1">.css-u5zpo1{-webkit-transition:all 0.15s ease-out;transition:all 0.15s ease-out;cursor:pointer;-webkit-text-decoration:none;text-decoration:none;outline:none;}.css-u5zpo1:hover{-webkit-text-decoration:underline;text-decoration:underline;}.css-u5zpo1:focus{box-shadow:0 0 0 3px rgba(66,153,225,0.6);}.css-u5zpo1:disabled,.css-u5zpo1:disabled:focus,.css-u5zpo1:disabled:hover,.css-u5zpo1[aria-disabled=true],.css-u5zpo1[aria-disabled=true]:focus,.css-u5zpo1[aria-disabled=true]:hover{opacity:0.4;cursor:not-allowed;-webkit-text-decoration:none;text-decoration:none;}</style><a href="spotify:user:peacecwz" class="css-u5zpo1"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 24 24" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><g><path fill="none" d="M0 0h24v24H0z"></path><path fill-rule="nonzero" d="M12 2c5.55 0 10 4.5 10 10s-4.5 10-10 10S2 17.5 2 12 6.5 2 12 2zm0 2c-4.395 0-8 3.605-8 8s3.605 8 8 8 8-3.605 8-8c0-4.414-3.573-8-8-8zm3.75 12.65c-2.35-1.45-5.3-1.75-8.8-.95-.35.1-.65-.15-.75-.45-.1-.35.15-.65.45-.75 3.8-.85 7.1-.5 9.7 1.1.35.15.4.55.25.85-.2.3-.55.4-.85.2zm1-2.7c-2.7-1.65-6.8-2.15-9.95-1.15-.4.1-.85-.1-.95-.5-.1-.4.1-.85.5-.95 3.65-1.1 8.15-.55 11.25 1.35.3.15.45.65.2 1s-.7.5-1.05.25zM6.3 9.75c-.5.15-1-.15-1.15-.6-.15-.5.15-1 .6-1.15 3.55-1.05 9.4-.85 13.1 1.35.45.25.6.85.35 1.3-.25.35-.85.5-1.3.25C14.7 9 9.35 8.8 6.3 9.75z"></path></g></svg></a></div><div class="css-uhmbuq"><a href="https://twitter.com/peacecwz" class="css-u5zpo1"><svg stroke="currentColor" fill="none" stroke-width="2" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z"></path></svg></a></div><div class="css-uhmbuq"><a href="https://medium.com/@peacecwz" class="css-u5zpo1"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 24 24" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><g><path fill="none" d="M0 0h24v24H0z"></path><path d="M4 3h16a1 1 0 0 1 1 1v16a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V4a1 1 0 0 1 1-1zm1 2v14h14V5H5zm12.3 10.94l.955.954v.05h-4.921v-.05l1.004-.954c.1-.1.15-.2.15-.351V9.664c0-.252 0-.603.051-.904l-3.314 8.285h-.05L7.76 9.412c-.05-.2-.1-.2-.15-.3v5.02c-.051.352 0 .653.15.955l1.356 1.807v.05H5.5v-.05l1.356-1.858c.15-.3.2-.652.15-.954V8.56c0-.251-.05-.553-.25-.753L5.851 6.55V6.5h3.515l2.912 6.478L14.84 6.5h3.415v.05l-.954 1.105c-.1.1-.15.251-.15.351v7.633c0 .1.05.251.15.301z"></path></g></svg></a></div><div class="css-uhmbuq"><a href="https://instagram.com/peacecwz.dev" class="css-u5zpo1"><svg stroke="currentColor" fill="none" stroke-width="2" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><rect x="2" y="2" width="20" height="20" rx="5" ry="5"></rect><path d="M16 11.37A4 4 0 1 1 12.63 8 4 4 0 0 1 16 11.37z"></path><line x1="17.5" y1="6.5" x2="17.5" y2="6.5"></line></svg></a></div><div class="css-uhmbuq"><a href="https://youtube.com/c/BarisCeviz" class="css-u5zpo1"><svg stroke="currentColor" fill="none" stroke-width="2" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M22.54 6.42a2.78 2.78 0 0 0-1.94-2C18.88 4 12 4 12 4s-6.88 0-8.6.46a2.78 2.78 0 0 0-1.94 2A29 29 0 0 0 1 11.75a29 29 0 0 0 .46 5.33A2.78 2.78 0 0 0 3.4 19c1.72.46 8.6.46 8.6.46s6.88 0 8.6-.46a2.78 2.78 0 0 0 1.94-2 29 29 0 0 0 .46-5.25 29 29 0 0 0-.46-5.33z"></path><polygon points="9.75 15.02 15.5 11.75 9.75 8.48 9.75 15.02"></polygon></svg></a></div><style data-emotion-css="cn730j">.css-cn730j{-webkit-transition:all .15s ease-in-out;transition:all .15s ease-in-out;margin-left:0.5rem;margin-right:0.5rem;}.css-cn730j:hover{-webkit-transform:scale(1.05);-ms-transform:scale(1.05);transform:scale(1.05);}</style><div class="css-cn730j"><a href="https://github.com/peacecwz" class="css-u5zpo1"><svg stroke="currentColor" fill="none" stroke-width="2" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path></svg></a></div><div class="css-cn730j"><a href="https://www.linkedin.com/in/peacecwz" class="css-u5zpo1"><svg stroke="currentColor" fill="none" stroke-width="2" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M16 8a6 6 0 0 1 6 6v7h-4v-7a2 2 0 0 0-2-2 2 2 0 0 0-2 2v7h-4v-7a6 6 0 0 1 6-6z"></path><rect x="2" y="9" width="4" height="12"></rect><circle cx="4" cy="4" r="2"></circle></svg></a></div><div class="css-cn730j"><a href="mailto:me@barisceviz.com" class="css-u5zpo1"><svg stroke="currentColor" fill="none" stroke-width="2" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg></a></div></div></div></div></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{}},"page":"/posts/dotnet-core-hosted-service-ile-azure-service-bus-kullanimi","query":{},"buildId":"3Tbb1Ssi_rBXemZl5xYuZ","nextExport":true,"autoExport":true,"isFallback":false}</script><script nomodule="" src="/_next/static/chunks/polyfills-ad7fa6b2f983b6a0d94c.js"></script><script src="/_next/static/chunks/main-13a97229ba9cfc2a8ca6.js" async=""></script><script src="/_next/static/chunks/webpack-22eaaa575d3c455933b4.js" async=""></script><script src="/_next/static/chunks/framework.1cde045124b4a7914091.js" async=""></script><script src="/_next/static/chunks/commons.5fafacf9ea4b892375d0.js" async=""></script><script src="/_next/static/chunks/266fce294f4d04e0decbbbd461ff4d16b8e17596.cb6044a5807bfb810729.js" async=""></script><script src="/_next/static/chunks/pages/_app-6a99d2d21d3a14a7bdb2.js" async=""></script><script src="/_next/static/chunks/78e521c3.7418446e8c21049a3cf3.js" async=""></script><script src="/_next/static/chunks/9469946b6dc0e9dd78922b308584ec0e18d81f50.2be113f6772e8c122bb8.js" async=""></script><script src="/_next/static/chunks/pages/posts/dotnet-core-hosted-service-ile-azure-service-bus-kullanimi-7928d271e24dff7743d1.js" async=""></script><script src="/_next/static/3Tbb1Ssi_rBXemZl5xYuZ/_buildManifest.js" async=""></script><script src="/_next/static/3Tbb1Ssi_rBXemZl5xYuZ/_ssgManifest.js" async=""></script></body></html>